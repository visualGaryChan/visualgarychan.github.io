<!DOCTYPE html>
<html>
  <head>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: rgb(244, 237, 225);
      }
    </style>
    <title>BNO VISA outside UK days calculator</title>
  </head>
  <body>
    <h1>BNO VISA outside UK days calculator</h1>
    <form>
      <table id="inputTable">
      <tr>
        <td rowspan="7" bgcolor="wheat" width="50%" style="text-align: left;">
          
          <p><u>1) 5-years VISA and apply for Indefinite Leave to Remain (ILR)</u><br>
            You must have spent no more than 180 days outside the UK in any 12 month period.<br>
            
          <p><u>2) After 1-year on ILR – eligible to apply for British Citizenship (BC)</u><br>
              You must spent no more than 450 days outside the UK during the 5 years before your application.<br>
              You must spent no more than 90 days outside the UK in the last 12 months.

          <p>This calculator will count the days from your BNO VISA approval date to see if you satisfy the rule 1.<br>
          
          <p>- Must enter the BNO VISA approval Date. <br>
            
          <p>- Must enter the First time enter UK Date. (Accepting a date before the approval date if you use LOTR / other method) <br>
          <p>- Please enter the leave UK date and enter UK date by trip. Please leave blank if you didn't have 8 trips.<br></p>
              
          <hr>
          <p><u>1) 5年簽証以申請永久居留權</u><br>
            申請人必須在英國連續居住 5 年，5 年期間任何連續的 12 個月內，不能離開英國多於 180 天<br></p>
          <p><u>2) ILR滿1年後 - 可以申請成為英國公民 (BC)</u><br>
              申請人取得永久居留權後需要住多 1 年，即第 6 年可申請入籍<br>
              申請人在入籍前 5 年內，不能離開英國多於 450 天，申請前 12 個月內不能離開英國多於 90 天 </p>
              
          <p>此日子計算機將根據你的BNO VISA批核日期來計算你是否符合上述之 (1)。</p>
          <p>- 必需輸入 BNO VISA 批核日期。</p>
          <p>- 必需輸入首次進入英國日期。 （接受因經LOTR / 其他方法而在批核日期前進入英國）</p>
          <p>- 請根據你離開及進入英國的日期於Trip中填寫。請將未用到的表格留空。</p>


          <hr>
          <p>Disclaimer: The information provided on this Website is for reference only. Please seek for the professionals or officials comments if needed.
          <p>免責聲明: 本網站所載的資料只供參考之用。如有需要，請尋求專業人士或官方協助。</p>
          <p>Version: 0.1 <br>
          Support by buy me a coffee :) Thank you so much <br>
          <a href="https://www.buymeacoffee.com/visualgary" target="_blank">https://www.buymeacoffee.com/visualGary</a></p>
        </td>
        <th colspan="2">
          <label for="approval-date">BNO VISA approval Date:</label>
          <input type="date" id="approval-date" required>
        </th>
      </tr>
      <tr>
        <th colspan="2">
          <label for="first-enter-date">First time enter UK Date:</label>
          <input type="date" id="first-enter-date" required>
          <br>
        </th>
      </tr>
      <tr>
        <th>
          <label for="trip1-leave-date">Trip 1 Leave UK Date:</label>
          <input type="date" id="trip1-leave-date">
          <br><br>
          <label for="trip1-enter-date">Trip 1 Enter UK Date:</label>
          <input type="date" id="trip1-enter-date">
          <br>
        </th>
        <th>
          <label for="trip5-leave-date">Trip 5 Leave UK Date:</label>
          <input type="date" id="trip5-leave-date">
          <br><br>
          <label for="trip5-enter-date">Trip 5 Enter UK Date:</label>
          <input type="date" id="trip5-enter-date">
          <br>
        </th>
      </tr>
      <tr>
        <th>
          <label for="trip2-leave-date">Trip 2 Leave UK Date:</label>
          <input type="date" id="trip2-leave-date">
          <br><br>
          <label for="trip2-enter-date">Trip 2 Enter UK Date:</label>
          <input type="date" id="trip2-enter-date">
          <br>
        </th>
        <th>
          <label for="trip6-leave-date">Trip 6 Leave UK Date:</label>
          <input type="date" id="trip6-leave-date">
          <br><br>
          <label for="trip6-enter-date">Trip 6 Enter UK Date:</label>
          <input type="date" id="trip6-enter-date">
          <br>
        </th>
      </tr>
      <tr>
        <th>
          <label for="trip3-leave-date">Trip 3 Leave UK Date:</label>
          <input type="date" id="trip3-leave-date">
          <br><br>
          <label for="trip3-enter-date">Trip 3 Enter UK Date:</label>
          <input type="date" id="trip3-enter-date">
          <br>
        </th>
        <th>
          <label for="trip7-leave-date">Trip 7 Leave UK Date:</label>
          <input type="date" id="trip7-leave-date">
          <br><br>
          <label for="trip7-enter-date">Trip 7 Enter UK Date:</label>
          <input type="date" id="trip7-enter-date">
          <br>
        </th>
      </tr>
      <tr>
        <th>
          <label for="trip4-leave-date">Trip 4 Leave UK Date:</label>
          <input type="date" id="trip4-leave-date">
          <br><br>
          <label for="trip4-enter-date">Trip 4 Enter UK Date:</label>
          <input type="date" id="trip4-enter-date">
          <br>
        </th>
        <th>
          <label for="trip8-leave-date">Trip 8 Leave UK Date:</label>
          <input type="date" id="trip8-leave-date">
          <br><br>
          <label for="trip8-enter-date">Trip 8 Enter UK Date:</label>
          <input type="date" id="trip8-enter-date">
          <br>
        </th>
      </tr>
      <tr>
        <th colspan="2">
          <button id="generateBtn" type="button" onclick="calculate()">Calculate</button>
        </th>
      </tr>
      </table>
</form>

<div id="resultContainer" style="display: none">
    <table>
      <tr>
        <td style="border: 0" >
          <h2>Not more than 180 days in any 12 rolling months during the 5 years before ILR application: 
          <output id="DayCountConclusion1"></output></h2>
        </td>
      </tr>
      <tr>
        <td style="border: 0" colspan="3" id="DayCountConclusion4">
        </td>
      </tr>
    </table>
    <div>
      <table id="tripTable">
        <thead>
          <tr>
            <th></th>
            <th>Before 1st entrance</th>
            <th>Trip 1</th>
            <th>Trip 2</th>
            <th>Trip 3</th>
            <th>Trip 4</th>
            <th>Trip 5</th>
            <th>Trip 6</th>
            <th>Trip 7</th>
            <th>Trip 8</th>
            <!--<th>TOTAL</th> -->
          </tr>
        </thead>
        <tbody id="tripTableBody">
          <tr>
            <th width="400">No. of full days outside UK</th>
            <th style="background-color: white" id="trip0-result"></th>
            <th style="background-color: white" id="trip1-result"></th>
            <th style="background-color: white" id="trip2-result"></th>
            <th style="background-color: white" id="trip3-result"></th>
            <th style="background-color: white" id="trip4-result"></th>
            <th style="background-color: white" id="trip5-result"></th>
            <th style="background-color: white" id="trip6-result"></th>
            <th style="background-color: white" id="trip7-result"></th>
            <th style="background-color: white" id="trip8-result"></th>
            <!-- <th style="background-color: rgb(244, 237, 225)wheat" id="total-result"></th> -->
          </tr>
        </tbody>
      </table>
    </div>
    <br>
    <div id="tableContainer">
      <table id="countDayTable">
        <thead id="tableHead">
          <tr>
            <th></th>
            <th>Jan</th>
            <th>Feb</th>
            <th>Mar</th>
            <th>Apr</th>
            <th>May</th>
            <th>Jun</th>
            <th>Jul</th>
            <th>Aug</th>
            <th>Sep</th>
            <th>Oct</th>
            <th>Nov</th>
            <th>Dec</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Generated table rows will be inserted here -->
        </tbody>
      </table>
      <br>
    </div>
</div>

    <script>
      let arr2d = [];
      const enumMonths = [undefined, 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      function isMonthEnd(date) {
        return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate() === date.getDate();
      }
      function calculateDaysOutsideUKByTrip(mode, start, end) {
        if (isNaN(start) || isNaN(end)) {
          return 0;
        }
        if (mode == 1) {
          // Trip mode
          if (start > end) {
            alert("Enter date must not be earlier than Leave date.");
            throw new Error ("Enter date must not be earlier than Leave date.");
          }
          const days = (end - start) / (1000 * 60 * 60 * 24) - 1;
          return (start.getTime() == end.getTime()) ? 0 : days;
        }
        // First enter mode
        const days = (end - start) / (1000 * 60 * 60 * 24);
        return (start >= end) ? 0 : days;
      }

      function countOutsideUKDaysInMonths(approvalDate, start, end){
        // same day in and out
        if (start.getTime() >= end.getTime() || isNaN(start) || isNaN(end)){
          return;
        }
        // same month in and out
        if (start.getFullYear() == end.getFullYear() && start.getMonth() == end.getMonth()){
          arr2d[start.getFullYear()-approvalDate.getFullYear()][start.getMonth()] += (end - start) / (1000 * 60 * 60 * 24) - 1;
        } else {
          // over month
          if (start.getFullYear() == end.getFullYear()){
            monthEndDate = new Date(start.getFullYear(), start.getMonth() + 1, 0);
            var temp = monthEndDate.getDate() - start.getDate();
            arr2d[start.getFullYear()-approvalDate.getFullYear()][start.getMonth()] += temp;
            for (let i = start.getMonth()+1 ; i < end.getMonth(); i++) {
              monthEndDate = new Date(start.getFullYear(), i+1, 0).getDate();
              arr2d[start.getFullYear()-approvalDate.getFullYear()][i] += monthEndDate;
            }
            arr2d[start.getFullYear()-approvalDate.getFullYear()][end.getMonth()] += end.getDate() - 1;
          } else {
          // over year
            monthEndDate = new Date(start.getFullYear(), start.getMonth() + 1, 0);
            var temp = monthEndDate.getDate() - start.getDate();
            arr2d[start.getFullYear()-approvalDate.getFullYear()][start.getMonth()] += temp;
            for (let i = start.getMonth()+1 ; i < 12; i++) {
              monthEndDate = new Date(start.getFullYear(), i+1, 0).getDate();
              arr2d[start.getFullYear()-approvalDate.getFullYear()][i] += monthEndDate;
            }
            for (let i = 0 ; i < end.getMonth(); i++) {
              monthEndDate = new Date(start.getFullYear(), i+1, 0).getDate();
              arr2d[start.getFullYear()-approvalDate.getFullYear()+1][i] += monthEndDate;
            } 
            arr2d[start.getFullYear()-approvalDate.getFullYear()+1][end.getMonth()] += end.getDate() - 1;
          }
        }
      }

      function calculate() {
        let tableContainer = document.getElementById("tableBody");
        tableContainer.innerHTML = "";

        const approvalDate = new Date(document.querySelector("#approval-date").value);
        const firstEnterDate = new Date(document.querySelector("#first-enter-date").value);
        const trip1LeaveDate = new Date(document.querySelector("#trip1-leave-date").value);
        const trip1EnterDate = new Date(document.querySelector("#trip1-enter-date").value);
        const trip2LeaveDate = new Date(document.querySelector("#trip2-leave-date").value);
        const trip2EnterDate = new Date(document.querySelector("#trip2-enter-date").value);
        const trip3LeaveDate = new Date(document.querySelector("#trip3-leave-date").value);
        const trip3EnterDate = new Date(document.querySelector("#trip3-enter-date").value);
        const trip4LeaveDate = new Date(document.querySelector("#trip4-leave-date").value);
        const trip4EnterDate = new Date(document.querySelector("#trip4-enter-date").value);
        const trip5LeaveDate = new Date(document.querySelector("#trip5-leave-date").value);
        const trip5EnterDate = new Date(document.querySelector("#trip5-enter-date").value);
        const trip6LeaveDate = new Date(document.querySelector("#trip6-leave-date").value);
        const trip6EnterDate = new Date(document.querySelector("#trip6-enter-date").value);
        const trip7LeaveDate = new Date(document.querySelector("#trip7-leave-date").value);
        const trip7EnterDate = new Date(document.querySelector("#trip7-enter-date").value);
        const trip8LeaveDate = new Date(document.querySelector("#trip8-leave-date").value);
        const trip8EnterDate = new Date(document.querySelector("#trip8-enter-date").value);

        enumYears = []
        for (let i = 0 ; i < 7 ; i++){
          enumYears[i] = approvalDate.getFullYear()+i;
        }

        let trip0DaysOutsideUK = 0;
        let trip1DaysOutsideUK = 0;
        let trip2DaysOutsideUK = 0;
        let trip3DaysOutsideUK = 0;
        let trip4DaysOutsideUK = 0;
        let trip5DaysOutsideUK = 0;
        let trip6DaysOutsideUK = 0;
        let trip7DaysOutsideUK = 0;
        let trip8DaysOutsideUK = 0;
        let totalDaysOutsideUK = 0;

        // create the 2d array for count rolling months
        const rows = 7;
        const columns = 12;

        for (let i = 0; i < rows; i++) {
          arr2d[i] = [];
          for(let j = 0; j < columns; j++) {
            arr2d[i][j] = 0;
          }
        }

        // calculation section
        trip0DaysOutsideUK = calculateDaysOutsideUKByTrip(0, approvalDate, firstEnterDate);
        trip1DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip1LeaveDate, trip1EnterDate);
        trip2DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip2LeaveDate, trip2EnterDate);
        trip3DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip3LeaveDate, trip3EnterDate);
        trip4DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip4LeaveDate, trip4EnterDate);
        trip5DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip5LeaveDate, trip5EnterDate);
        trip6DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip6LeaveDate, trip6EnterDate);
        trip7DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip7LeaveDate, trip7EnterDate);
        trip8DaysOutsideUK = calculateDaysOutsideUKByTrip(1, trip8LeaveDate, trip8EnterDate);
        totalDaysOutsideUK = trip0DaysOutsideUK + trip1DaysOutsideUK + trip2DaysOutsideUK + trip3DaysOutsideUK + trip4DaysOutsideUK;
        totalDaysOutsideUK += trip5DaysOutsideUK + trip6DaysOutsideUK + trip7DaysOutsideUK + trip8DaysOutsideUK;
     
        // output section
        document.querySelector("#trip0-result").innerHTML = trip0DaysOutsideUK;
        document.querySelector("#trip1-result").innerHTML = trip1DaysOutsideUK;
        document.querySelector("#trip2-result").innerHTML = trip2DaysOutsideUK;
        document.querySelector("#trip3-result").innerHTML = trip3DaysOutsideUK;
        document.querySelector("#trip4-result").innerHTML = trip4DaysOutsideUK;
        document.querySelector("#trip5-result").innerHTML = trip5DaysOutsideUK;
        document.querySelector("#trip6-result").innerHTML = trip6DaysOutsideUK;
        document.querySelector("#trip7-result").innerHTML = trip7DaysOutsideUK;
        document.querySelector("#trip8-result").innerHTML = trip8DaysOutsideUK;
        //document.querySelector("#total-result").innerHTML = totalDaysOutsideUK;

        // table 
        let holidayDays = {};
        countOutsideUKDaysInMonths(approvalDate, approvalDate, firstEnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip1LeaveDate, trip1EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip2LeaveDate, trip2EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip3LeaveDate, trip3EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip4LeaveDate, trip4EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip5LeaveDate, trip5EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip6LeaveDate, trip6EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip7LeaveDate, trip7EnterDate);
        countOutsideUKDaysInMonths(approvalDate, trip8LeaveDate, trip8EnterDate);

        // counting in rolling 12 months
        const arr1d = arr2d.flat();
        let daySum = 0;
        let k = 0 ;
        let exceedYear = -1;
        let exceedMonth = -1;
        for (k = 0; k <= arr1d.length - 12; k++) {
          const twelveElements = arr1d.slice(k, k + 12);
          daySum = twelveElements.reduce((acc, val) => acc + val, 0);
          if (daySum > 180) {
            exceedYear = parseInt(k/12);
            exceedMonth = parseInt(k%12);
            alert(`Over 180days outside UK found. \nStarting: ${enumYears[exceedYear]}-${enumMonths[exceedMonth+1]} with days: ${daySum}`);
            break;
          }
        }
        
        // print out the table wtih colour
        let colourExceed180Days = 0;
        for (let i = 0; i < arr2d.length; i++) {
          let row = arr2d[i];
          let rowElement = document.createElement("tr");
          
          for (let j = 0; j < row.length + 1; j++) {
            let cell;

            if (j === 0) {
              cell = approvalDate.getFullYear() + i;
            } else {
              cell = row[j - 1];
            }
            
            let cellElement = document.createElement("td");
            cellElement.innerHTML = cell;

            if (j > 0) {
              if ((i === exceedYear && j === exceedMonth + 1) || (colourExceed180Days > 0 && colourExceed180Days < 12)) {
                cellElement.style.backgroundColor = "yellow";
                colourExceed180Days += 1;
              }
            }
            rowElement.appendChild(cellElement);
          }
          tableContainer.appendChild(rowElement);
        }

        // print out conclusion
        if (daySum > 180){
          document.querySelector("#DayCountConclusion1").innerHTML = `<font color="red">  X  </font>`;
        } else {
          document.querySelector("#DayCountConclusion1").innerHTML = `<font color="green">  ✓  </font>`;
        }

        if (daySum > 180 || totalDaysOutsideUK > 450){
          document.querySelector("#DayCountConclusion4").innerHTML = `<h2><font color="red">Unfortunately, you may failed the settlement requirement.</font></h2>`;
        } else {
          document.querySelector("#DayCountConclusion4").innerHTML = `<h2><font color="green">Congratulations! You didn't not exceed the allowed days of outside UK days for now.</font></h2>`;
        }
        document.querySelector("#resultContainer").style.display = "block";
      }
    </script>
  </body>
</html>